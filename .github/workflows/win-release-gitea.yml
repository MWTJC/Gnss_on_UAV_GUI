defaults:
  run:
    shell: powershell

name: gitea-CI-sparrow-poetry
on:
  push:
    tags:
      - "v*"  # ä»¥vå¼€å¤´

jobs:
  poetry-src-regen:
    runs-on: windows-amd64
    env:
      PYTHONIOENCODING: 'utf-8'
      PYTHONUTF8: 1
      GITEA_TOKEN: ${{ secrets.RELEASE_TOKEN }}
      ACTIONS_URL: https://mwtjc.online:14086/
      GITEA_API_URL: https://mwtjc.online:14086/api/v1/
      APP_FOLDER_NAME: 'PySideApp'
    steps:
      - name: æ£€å‡ºrepo
        uses: ${{ env.ACTIONS_URL }}actions/checkout@v4
        with:
          fetch-depth: 0  # è·å–å®Œæ•´çš„gitå†å²è®°å½•

      - name: å–å¾—hashæ ‡è®°ç¬¦
        uses: ${{ env.ACTIONS_URL }}actions/go-hashfiles@v0.0.1
        id: hash-go
        with:
          patterns: |-
            py312-win.lock
            pyproject.toml

      - name: ç¯å¢ƒå®‰è£…
        run: |
          pdm use 3.12
          pdm install --lockfile=py312-win.lock
          pdm list
          pdm info

      - name: pyuièµ„æºæ›´æ–°
        working-directory: ${{ env.APP_FOLDER_NAME }}\scripts
        run: pdm run regen_ui.py

      - name: æ„å»ºå‰æµ‹è¯•
        run: pdm run test

      - name: å–å¾—ç¼“å­˜ nuitka
        uses: ${{ env.ACTIONS_URL }}actions/cache/restore@v4
        with:
          path: |
            .\dist
          key: dist-${{ steps.hash-go.outputs.hash }}

      - name: Nuitkaæ„å»º
        run: pdm run build

      - name: ç¼“å­˜ nuitka
        uses: ${{ env.ACTIONS_URL }}actions/cache/save@v4
        with:
          path: |
            .\dist
          key: dist-${{ steps.hash-go.outputs.hash }}

      - name: å‹ç¼©7z
        run: 7z.exe a -t7z -m0=LZMA2 -mmt=on -mx9 -mqs=on -bsp2  -mtc=on -mta=on ".\dist7z.7z" ".\dist\${{ env.APP_FOLDER_NAME }}.dist"

      - name: æ–‡ä»¶ä¿¡æ¯
        run: |
          # è·å–çŸ­ commit hash
          $commit = git rev-parse --short HEAD
          # è·å–æ–‡ä»¶å¤§å°ï¼ˆä»¥ MB ä¸ºå•ä½ï¼‰
          $size = [math]::Round((Get-Item "dist7z.7z").length / 1MB, 2)
          echo FILE_SIZE: "${size}MB"

      # ç”Ÿæˆ changelog
      - name: ç”Ÿæˆ changelog
        run: |
          $CURRENT_TAG = $env:GITHUB_REF -replace 'refs/tags/', ''
          $PREVIOUS_TAG = git tag -l 'v*' --sort=-v:refname | Select-String -Pattern "^${CURRENT_TAG}$" -Context 0,1 | ForEach-Object { $_.Context.PostContext[0] }
          
          $CHANGELOG = @"
          # ğŸ‰ Release $CURRENT_TAG
          
          ## ğŸ“ Changelog
          
          "@
          
          if ($PREVIOUS_TAG) {
            $CHANGELOG += "Changes between $PREVIOUS_TAG and $CURRENT_TAG:`n`n"
          } else {
            $CHANGELOG += "Initial release $CURRENT_TAG:`n`n"
          }
          
          # è·å–ä¸åŒç±»å‹çš„æäº¤
          $FEATURES = git log --pretty=format:"- âœ¨ %s (%h) by @%an" "${PREVIOUS_TAG}..${CURRENT_TAG}" --grep="^feat"
          $FIXES = git log --pretty=format:"- ğŸ› %s (%h) by @%an" "${PREVIOUS_TAG}..${CURRENT_TAG}" --grep="^fix"
          $DOCS = git log --pretty=format:"- ğŸ“š %s (%h) by @%an" "${PREVIOUS_TAG}..${CURRENT_TAG}" --grep="^docs"
          $OTHER = git log --pretty=format:"- ğŸ”§ %s (%h) by @%an" "${PREVIOUS_TAG}..${CURRENT_TAG}" --invert-grep --grep="^(feat|fix|docs|ci)"
          
          # ç»„åˆå†…å®¹
          $CONTENT = @"
          
          ### âœ¨ ç‰¹æ€§
          
          $FEATURES
          
          ### ğŸ› Bugä¿®å¤
          
          $FIXES
          
          ### ğŸ“š æ–‡æ¡£
          
          $DOCS
          
          ### ğŸ”§ å…¶ä»–
          
          $OTHER
          "@
          
          # å†™å…¥æ–‡ä»¶
          $CHANGELOG + $CONTENT | Out-File -FilePath "changelog.md" -Encoding UTF8


      - name: PreRelease
        uses: ${{ env.ACTIONS_URL }}actions/gitea-release-action@v1
        with:
          files: |
            dist7z.7z
          body_path: changelog.md
          prerelease: true
          md5sum: true



